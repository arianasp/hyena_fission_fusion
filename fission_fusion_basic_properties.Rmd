---
title: "fission_fusion_basic_properties"
author: "Ariana Strandburg-Peshkin & Eli Strauss"
date: "1/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#set directories
codedir <- '~/Dropbox/code_ari/hyena_fission_fusion/'
datadir <- '~/Dropbox/hyenas/hyena_fission_fusion/data/'

processeddir <- paste0(datadir,'processed/')
rawdir <- paste0(datadir,'raw/')

#FUNCTIONS
setwd(codedir)
source('hyena_functions.R')

#LIBRARIES
library(fields)
library(lubridate)

#Set working directory
setwd(rawdir)

#Load data
load('hyena_xy_level1.RData')
load('hyena_timestamps.Rdata')
load('hyena_ids.RData')
load('hyena_vedba.RData')

#Read in den data
den.file <- 'hyena_isolate_dens.csv'
den.names <- c('DAVE D','RBEND D','RES M D1','DICK D')
known.locs <- read.csv(den.file,stringsAsFactors=F)
eastsNorths <- latlon.to.utm(cbind(known.locs$lon,known.locs$lat),southern_hemisphere=T,utm.zone=36)
known.locs$east <- eastsNorths[,1]
known.locs$north <- eastsNorths[,2]
den.locs <- known.locs[which(known.locs$name %in% den.names),]
den.locs$name <- as.character(den.locs$name)

setwd(processeddir)
load('fission_fusion_features.RData')

good.idxs <- which(events$start.exact & events$end.exact)

```

## Some basic exploration of fission-fusion events

Overall, there are `r nrow(events)` fission-fusion events total in our dataset. Of these, `r length(good.idxs)` have defined starting and ending points. We will focus on these 'comlete' events for the purposes of this initial analysis. 

First, let's get some basic info. How long do these events tend to be?

```{r duration distribution}

hist((events$t.end[good.idxs] - events$t.start[good.idxs])/60/60, breaks = 100, main = 'Duration of fission-fusion events', xlab = 'Time (hours)', ylab = 'Frequency', col = 'gray')

```

How far do two hyenas typically travel during a fission-fusion event? The plot below shows the distribution of displacements for one of the hyenas during the entire event

```{r displacement distribution}

#get total displacement of i during the event
dx <- xs[cbind(events$i[good.idxs], events$t.end[good.idxs])] -  xs[cbind(events$i[good.idxs], events$t.start[good.idxs])]
dy <- ys[cbind(events$i[good.idxs], events$t.end[good.idxs])] -  ys[cbind(events$i[good.idxs], events$t.start[good.idxs])]
ds <- sqrt(dx^2 + dy^2)

hist(ds, breaks = 100, main = 'Displacement during fission-fusion events', xlab = 'Displacement (m)', ylab = 'Frequency', col = 'gray')

```

How close do hyenas normally get during fission-fusion events?

```{r closest approach}

hist(events$closest.app[good.idxs], breaks = 20, main = 'Closest approach during fission-fusion events', xlab = 'Displacement (m)', ylab = 'Frequency', col = 'gray')

```

Where do fission-fusion events occur? How often do they occur at dens?

Let's look at the distance to the closest den at the start of events (for the hyena closest to the den):

```{r distance from den}

dist.to.den.start <- dist.to.den.end <- matrix(nrow = nrow(events), ncol = nrow(den.locs))
dist.den.all <- array(dim = c(nrow(xs), ncol(xs), nrow(den.locs)))
for(i in 1:nrow(den.locs)){
  x.d <- den.locs$east[i]
  y.d <- den.locs$north[i]
  
  #start of event
  dxi <- xs[cbind(events$i, events$t.start)] - x.d
  dyi <- ys[cbind(events$i, events$t.start)] - y.d
  ddi <- sqrt(dxi^2 + dyi^2)
  dxj <- xs[cbind(events$j, events$t.start)] - x.d
  dyj <- ys[cbind(events$j, events$t.start)] - y.d
  ddj <- sqrt(dxj^2 + dyj^2)
  dist.to.den.start[,i] <- apply(X = cbind(ddi,ddj), MARGIN = 1, FUN = min, na.rm=T)
  
  #end of event
  dxi <- xs[cbind(events$i, events$t.end)] - x.d
  dyi <- ys[cbind(events$i, events$t.end)] - y.d
  ddi <- sqrt(dxi^2 + dyi^2)
  dxj <- xs[cbind(events$j, events$t.end)] - x.d
  dyj <- ys[cbind(events$j, events$t.end)] - y.d
  ddj <- sqrt(dxj^2 + dyj^2)
  dist.to.den.end[,i] <- apply(X = cbind(ddi,ddj), MARGIN = 1, FUN = min, na.rm=T)
  
  #over all times
  dx.all <- xs - x.d
  dy.all <- ys - y.d
  dist.den.all[,,i] <- sqrt(dx.all^2 + dy.all^2)
  
}

#min dist to den at start and end of events
min.dist.to.den.start <- apply(dist.to.den.start, 1, min, na.rm=T)
min.dist.to.den.end <- apply(dist.to.den.end, 1, min, na.rm=T)

#min distance to den overall
idxs.to.use <- seq(1, ncol(xs), by = 60)
idxs.to.use <- idxs.to.use[which(colSums(is.na(xs[,idxs.to.use])) == 0)]
min.dist.to.den.all <- apply(dist.den.all[,idxs.to.use,], c(1,2), function(x){return(min(x,na.rm=T))})

par(mfrow=c(1,3))

hist(min.dist.to.den.start, breaks = seq(0,6000,100), main = 'Dist to closest den at event start', xlab = 'Distance (m)', ylab = 'Probability density', col = 'gray', freq=F, ylim = c(0,.007))

hist(min.dist.to.den.end, breaks = seq(0,6000,100), main = 'Dist to closest den at event end', xlab = 'Distance (m)', ylab = 'Probability density', col = 'gray', freq=F, ylim = c(0,.007))

#overall distance to den across all data
hist(min.dist.to.den.all, breaks = seq(0,20000,100), xlim = c(0,6000), main = 'Dist to closest den over all data', xlab = 'Distance (m)', ylab = 'Probability density', col = 'gray',freq=F, ylim = c(0,.007))

```

To simplify, we can just ask whether hyenas are at the den or not (less than 200 m from nearest den).

```{r at den or not}
R.den <- 200

at.den.start <- mean(min.dist.to.den.start < R.den)
at.den.end <- mean(min.dist.to.den.end < R.den)
at.den.all <- mean(min.dist.to.den.all < R.den)

```

Overall, we find that fission-fusion events start at the den `r round(at.den.start*100)`% of the time and end at the den `r round(at.den.end*100)`% of the time. This can be compared to the total amount of time that hyenas spend close to dens, which is `r round(at.den.all*100)`%. As expected, fission-fusion events occur a large proportion of the time at dens, but not always. If we expand our definition of 'at the den' to include up to 500 m away from the den, then these numbers change to `r round(mean(min.dist.to.den.start < 500)*100)`% at event start, `r round(mean(min.dist.to.den.end < 500)*100)`% at event end, and `r round(mean(min.dist.to.den.all < 500)*100)`% over all the data. 

What time of day do fission-fusion events occur?

```{r fission-fusion time of day}

hist(hour(timestamps[events$t.start]+3*60*60), breaks = seq(0,24,1), xlab = 'Time of day (hour)', ylab = 'Frequency', col = rainbow(24), main = 'Time of day of fission-fusion event starts')
hist(hour(timestamps[events$t.end]+3*60*60), breaks = seq(0,24,1), xlab = 'Time of day (hour)', ylab = 'Frequency', col = rainbow(24), main = 'Time of day of fission-fusion event ends')

```

Who takes part in fission-fusion events, and how often? 

```{r number of events per dyad}

n.events.per.dyad <- tot.dur.per.dyad <- dyad.tracked <- matrix(nrow=nrow(xs), ncol = nrow(xs))
for(i in 1:(nrow(xs)-1)){
  for(j in (i+1):nrow(xs)){
    n.events.per.dyad[i,j] <- length(which(events$i == i & events$j==j))
    tot.dur.per.dyad[i,j] <- sum((events$t.end - events$t.start)[which(events$i == i & events$j==j)])
    dyad.tracked[i,j] <- sum(!is.na(xs[i,] & !is.na(xs[j,])))
  }
}

image.plot(n.events.per.dyad, xaxt = 'n', yaxt = 'n', col = viridis(256))
axis(side = 1, at = seq(0,1, length.out = nrow(hyena.ids)), hyena.ids$name)
axis(side = 2, at = seq(0,1, length.out = nrow(hyena.ids)), hyena.ids$name)
title(main = 'Number of events per dyad')

image.plot(tot.dur.per.dyad / dyad.tracked * 100, xaxt = 'n', yaxt = 'n', col = viridis(256))
axis(side = 1, at = seq(0,1, length.out = nrow(hyena.ids)), hyena.ids$name)
axis(side = 2, at = seq(0,1, length.out = nrow(hyena.ids)), hyena.ids$name)
title(main = 'Percentage of time tracked spent together per dyad')

```

Clearly there is some variation, which likely reflects a combination of social preferences and ranging patterns / shared den use. We can get into this more later.